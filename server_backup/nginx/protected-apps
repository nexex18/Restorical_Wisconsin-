# Nginx configuration with explicit FastHTML routes
# All FastHTML paths are explicitly defined to avoid routing issues

server {
    listen 80;
    server_name _;
    
    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Basic Authentication - Applied globally
    auth_basic "Restricted Access - Authentication Required";
    auth_basic_user_file /etc/nginx/.htpasswd;
    
    # ========================================
    # FastHTML Routes - All explicitly defined
    # ========================================
    
    # Homepage route (special case - only when explicitly accessing /fasthtml/)
    location = /fasthtml {
        return 301 /fasthtml/;
    }
    
    location /fasthtml/ {
        proxy_pass http://127.0.0.1:5001/;
        proxy_http_version 1.1;
        
        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket support
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Disable buffering
        proxy_buffering off;
        
        # Timeouts
        proxy_connect_timeout 3600s;
        proxy_send_timeout 3600s;
        proxy_read_timeout 3600s;
    }
    
    # Main Pages
    location /recent-sites {
        proxy_pass http://127.0.0.1:5001/recent-sites;
        include /etc/nginx/fasthtml_proxy.conf;
    }
    
    location ~ ^/results/([0-9]+)$ {
        proxy_pass http://127.0.0.1:5001/results/$1$is_args$args;
        include /etc/nginx/fasthtml_proxy.conf;
    }
    
    # Processing Routes
    location = /process {
        proxy_pass http://127.0.0.1:5001/process;
        include /etc/nginx/fasthtml_proxy.conf;
    }
    
    location ~ ^/process-async/([0-9]+)$ {
        proxy_pass http://127.0.0.1:5001/process-async/$1$is_args$args;
        include /etc/nginx/fasthtml_proxy.conf;
    }
    
    # Feedback Routes
    location ~ ^/feedback-form/([0-9]+)/([^/]+)$ {
        proxy_pass http://127.0.0.1:5001/feedback-form/$1/$2$is_args$args;
        include /etc/nginx/fasthtml_proxy.conf;
    }
    
    location ~ ^/submit-feedback/([0-9]+)/([^/]+)$ {
        proxy_pass http://127.0.0.1:5001/submit-feedback/$1/$2$is_args$args;
        include /etc/nginx/fasthtml_proxy.conf;
    }
    
    # Documents Route
    location ~ ^/documents/([0-9]+)$ {
        proxy_pass http://127.0.0.1:5001/documents/$1$is_args$args;
        include /etc/nginx/fasthtml_proxy.conf;
    }
    
    # View Results Route
    location = /view-results {
        proxy_pass http://127.0.0.1:5001/view-results;
        include /etc/nginx/fasthtml_proxy.conf;
    }
    
    
    # Counties Routes
    location = /counties {
        return 301 /counties/;
    }
    
    location /counties/ {
        proxy_pass http://127.0.0.1:5001/counties/;
        include /etc/nginx/fasthtml_proxy.conf;
    }
    
    # County report redirect handler
    location = /county-report-redirect {
        proxy_pass http://127.0.0.1:5001/county-report-redirect;
        include /etc/nginx/fasthtml_proxy.conf;
    }
    
    # County report viewer (with dynamic parameter)
    location ~ ^/county-report/([^/]+)$ {
        proxy_pass http://127.0.0.1:5001/county-report/$1$is_args$args;
        include /etc/nginx/fasthtml_proxy.conf;
    }
    # API Routes
    # ========================================
    # Feedback API Routes (Campaign Planning)
    # ========================================
    
    # Email feedback endpoint
    location = /api/feedback {
        # auth_basic is inherited from server block
        proxy_pass http://127.0.0.1:8001/api/feedback;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # CORS headers for feedback forms
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "*" always;
        add_header Access-Control-Allow-Credentials "true" always;
        
        # Handle OPTIONS
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
            add_header Access-Control-Allow-Headers "*" always;
            add_header Access-Control-Max-Age 86400;
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }
    }
    
    # Sales feedback endpoint
    location = /api/sales-feedback {
        # auth_basic is inherited from server block
        proxy_pass http://127.0.0.1:8001/api/sales-feedback;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # CORS headers for feedback forms
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "*" always;
        add_header Access-Control-Allow-Credentials "true" always;
        
        # Handle OPTIONS
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
            add_header Access-Control-Allow-Headers "*" always;
            add_header Access-Control-Max-Age 86400;
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }
    }
    
    # All feedback data endpoint (protected)
    location = /api/all-feedback {
        proxy_pass http://127.0.0.1:8001/api/all-feedback;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    location /api/ {
        proxy_pass http://127.0.0.1:5001/api/;
        include /etc/nginx/fasthtml_proxy.conf;
    }
    
    # Static files (if FastHTML serves any)
    location /static/ {
        proxy_pass http://127.0.0.1:5001/static/;
        include /etc/nginx/fasthtml_proxy.conf;
    }
    
    # Health Check (no auth required)
    location = /health {
        auth_basic off;
        proxy_pass http://127.0.0.1:5001/health;
        include /etc/nginx/fasthtml_proxy.conf;
    }
    
    # ========================================
    # Streamlit Application
    # ========================================
    
    location = /streamlit {
        return 301 /streamlit/;
    }
    
    location /streamlit/ {
        proxy_pass http://127.0.0.1:8501/;
        proxy_http_version 1.1;
        
        # WebSocket support
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # Disable buffering
        proxy_buffering off;
        proxy_cache_bypass $http_upgrade;
        
        # Timeout
        proxy_read_timeout 86400;
    }
    
    # ========================================
    # Landing Page (must be last - lowest priority)
    # ========================================
    
    location / {
        root /var/www/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
}
